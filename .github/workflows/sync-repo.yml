name: Sync Repository

# è§¦å‘æ¡ä»¶ï¼šæ¯24å°æ—¶è‡ªåŠ¨æ‰§è¡Œå’Œæ‰‹åŠ¨è§¦å‘
on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´08:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: read

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
    
    - name: Add remote source repository
      run: |
        git remote add source https://cnb.cool/EnderRealm/public/MCBEPackCrypt
        git remote -v
    
    - name: Fetch from source repository
      run: |
        git fetch source
    
    - name: Backup protected files
      run: |
        # å¤‡ä»½éœ€è¦ä¿æŠ¤çš„æ–‡ä»¶
        mkdir -p /tmp/backup
        cp -r .github /tmp/backup/
        cp SYNC_INFO.md /tmp/backup/ 2>/dev/null || true
        cp SYNC_INFO_ZH.md /tmp/backup/ 2>/dev/null || true
        echo "Protected files backed up"
    
    - name: Merge from source repository
      run: |
        # ç›´æ¥åˆå¹¶æºä»“åº“çš„æ›´æ”¹
        git merge source/main --no-edit || {
          echo "Merge conflict detected, using source version for conflicted files except protected ones"
          git checkout source/main -- . || true
          git checkout HEAD -- .github/ SYNC_INFO.md SYNC_INFO_ZH.md 2>/dev/null || true
          git add .
        }
        echo "Merge completed"
    
    - name: Restore protected files and update timestamps
      run: |
        # æ¢å¤ä¿æŠ¤çš„æ–‡ä»¶å¹¶æ›´æ–°æ—¶é—´æˆ³
        cp -r /tmp/backup/.github .
        CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
        if [ -f "/tmp/backup/SYNC_INFO.md" ]; then
          sed "s/\[AUTO_UPDATE_TIME\]/$CURRENT_TIME/g" /tmp/backup/SYNC_INFO.md > SYNC_INFO.md
        fi
        if [ -f "/tmp/backup/SYNC_INFO_ZH.md" ]; then
          sed "s/\[AUTO_UPDATE_TIME\]/$CURRENT_TIME/g" /tmp/backup/SYNC_INFO_ZH.md > SYNC_INFO_ZH.md
        fi
        echo "Protected files restored with updated timestamp"
    
    - name: Commit and push changes
      run: |
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹å¹¶æäº¤
        git add .
        if ! git diff --cached --quiet; then
          git commit -m "Auto-sync from source repository [$(date '+%Y-%m-%d %H:%M:%S UTC')]"
          git push origin main
          echo "âœ… Changes committed and pushed successfully"
        else
          echo "â„¹ï¸ No changes to commit"
        fi
    
    - name: Sync summary
      run: |
        echo "ğŸ”„ Repository sync completed at $(date)"
        echo "ğŸ“ Source: https://cnb.cool/EnderRealm/public/MCBEPackCrypt"
        echo "ğŸ¯ Target: ${{ github.repository }}"
        echo "âœ¨ Sync process finished successfully"